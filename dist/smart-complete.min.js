/*!
 * smart-complete - 为input和textarea提供提示补全功能的AngularJS指令
 * @version 2.0.4
 * @link https://github.com/zskymn/smart-complete#readme
 */
!function(t,e){"function"==typeof define&&define.amd?define(["jquery","angular"],e):"object"==typeof module&&module.exports?module.exports=e(require("jquery"),require("angular")):e(t.jQuery,t.angular)}(this,function(t,e){e.module("smart-complete",[]),e.module("smart-complete").service("$scUtil",["$timeout","$q",function(t,e){function n(e,n){var i=null;return 0===n||n||(n=300),function(){var o=this,r=arguments;return t.cancel(i),i=t(function(){return e.apply(o,r)},n)}}function i(){return e.when([])}var o=this;o.debounce=n,o.noopSearchFunc=i}]),e.module("smart-complete").directive("smartComplete",["$parse","$scUtil","$timeout",function(n,i,o){return{restrict:"A",link:function(r,s,c){function l(){if(g=s[0].tagName.toLowerCase(),b=n(c.smartComplete),k=n(c.scSep),w=n(c.scTrim||"true"),y=n(c.scWidth),C=n(c.scHeight),j=n(c.scItemClickCb),x=n(c.scEnterCb),$="current-selected","input"!==g&&"textarea"!==g)throw"tagName must be input or textarea";T=t('<ul class="smart-complete"></ul>'),s.after(T),a(),f()}function u(e){return w(r)?t.trim(e):e}function a(){s.css("font-size",s.css("font-size")),"textarea"===g&&s.css({overflow:"auto",overflowX:"auto",overflowY:"auto",wordBreak:"break-all"}),T.hide()}function f(){s.off("click.sc").on("click.sc",h).off("keyup.sc").on("keyup.sc",i.debounce(function(t){var e=t.which;13!==e&&38!==e&&40!==e&&9!==e&&h()})).off("keydown.sc").on("keydown.sc",function(t){var n,i=t.which;if(13===i)return T.is(":visible")&&(t.preventDefault(),T.hide()),void o(function(){(x(r)||e.noop)(u(s.val()))});if(9===i)return void(T.is(":visible")&&T.hide());if(38===i)n=!0;else{if(40!==i)return;n=!1}t.preventDefault(),d(n)}),T.off("mouseenter.sc").on("mouseenter.sc","li",function(){t(this).addClass($)}).off("mouseleave.sc").on("mouseleave.sc","li",function(){T.children().removeClass($)}).off("click.sc").on("click.sc","li",function(){m(t(this).attr("value"));var n=t(this).attr("value");o(function(){(j(r)||e.noop)(n,s.val())}),T.hide()}),t(document).on("click.sc",function(){T.hide()})}function p(){var t=s.caret("pos"),e=k(r);if(!e)return s.val();e+="";var n=s.val();return n.substring(0,t).split(e).pop()+n.substring(t).split(e)[0]}function v(){var e,n,i,o=y(r),c=parseInt(C(r),10)||240,l=k(r),u=s.position(),a=s.outerWidth(),f=s.outerHeight(),p=s.caret("pos"),v=s.caret("position"),h=s.val();l?(l+="",e=s.caret("position",p-h.substring(0,p).split(l).pop().length)):(e=s.caret("position",0),e.left=0),"100%"===o?(o=s.outerWidth(),n=0):(o=parseInt(o,10)||240,n=o>=a?0:e.left+o>=a?a-o:e.left),"input"===g?i=f:(i=v.top+v.height-s.scrollTop(),v.top>e.top&&(n=0));var d=0,m=0,b=s.parents().filter(function(){var e=t(this).css("position");return"absolute"===e||"fixed"===e||"relative"===e})[0];if(b){var w=t(b);d=w.scrollTop(),m=w.scrollLeft()}return{width:o,maxHeight:c,left:u.left+m+parseInt(s.css("marginLeft"),10)+n,top:u.top+d+parseInt(s.css("marginTop"),10)+i+2}}function h(){var n=p();(b(r)||i.noopSearchFunc)(u(n)).then(function(n){return t.map(n,function(t){return e.isObject(t)?t:{label:t,value:t}})},function(){return[]}).then(function(e){return 0===e.length?void T.html("").hide():void T.html(t.map(e,function(t){return'<li value="'+t.value+'">'+t.label+"</li>"}).join("")).css(v()).show().css(v())})}function d(t){if(!T.is(":hidden")){var e=T.children();if(0!==e.length){var n=e.filter("."+$).first(),i=n;if(n.length)if(t){var o=n.prev();o.length&&(i=o)}else{var r=n.next();r.length&&(i=r)}else i=t?e.last():e.first();e.removeClass($),i.addClass($),m(i.attr("value"));var s=i.position().top,c=0,l=T.height()-i.height();return s>l&&T.scrollTop(T.scrollTop()+s-l),s<c?T.scrollTop(T.scrollTop()+s-c):void 0}}}function m(t){var e,n,i,o,c,l,u=k(r);return u?(u+="",n=s.caret("pos"),c=s.val(),e=c.substring(0,n),l=e.split(u),o=l.pop(),l.push(t),c.substring(n)&&(i=c.substring(n).split(u),i.shift(),i.join(u)&&l.push(i.join(u))),s.val(l.join(u)).caret("pos",n+t.length-o.length),void s.focus().trigger("change")):void s.val(t).focus().trigger("change")}var g,b,k,w,y,C,j,x,T,$;l()}}}])});