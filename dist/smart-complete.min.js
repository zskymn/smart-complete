/*!
 * smart-complete - 为input和textarea提供提示补全功能的AngularJS指令
 * @version 2.0.5
 * @link https://github.com/zskymn/smart-complete#readme
 */
!function(e,t){"function"==typeof define&&define.amd?define(["jquery","angular"],t):"object"==typeof module&&module.exports?module.exports=t(require("jquery"),require("angular")):t(e.jQuery,e.angular)}(this,function(e,t){t.module("smart-complete",[]),t.module("smart-complete").service("$scUtil",["$timeout","$q",function(e,t){function n(t,n){var r=null;return 0===n||n||(n=300),function(){var i=this,o=arguments;return e.cancel(r),r=e(function(){return t.apply(i,o)},n)}}function r(){return t.when([])}var i=this;i.debounce=n,i.noopSearchFunc=r}]),t.module("smart-complete").directive("smartComplete",["$parse","$scUtil","$timeout",function(n,r,i){return{restrict:"A",link:function(o,s,l){function c(){if(g=s[0].tagName.toLowerCase(),b=n(l.smartComplete),x=n(l.scSep),k=n(l.scTrim||"true"),w=n(l.scWidth),y=n(l.scHeight),I=n(l.scItemClickCb),C=n(l.scEnterCb),j="current-selected","input"!==g&&"textarea"!==g)throw"tagName must be input or textarea";T=e('<ul class="smart-complete"></ul>'),s.after(T),u(),f()}function a(t){return k(o)?e.trim(t):t}function u(){s.css("font-size",s.css("font-size")),"textarea"===g&&s.css({overflow:"auto",overflowX:"auto",overflowY:"auto",wordBreak:"break-all"}),T.hide()}function f(){s.off("click.sc").on("click.sc",v).off("keyup.sc").on("keyup.sc",r.debounce(function(e){var t=e.which;13!==t&&38!==t&&40!==t&&9!==t&&v()})).off("keydown.sc").on("keydown.sc",function(e){var n,r=e.which;if(13===r)return T.is(":visible")&&(e.preventDefault(),T.hide()),void i(function(){(C(o)||t.noop)(a(s.val()))});if(9===r)return void(T.is(":visible")&&T.hide());if(38===r)n=!0;else{if(40!==r)return;n=!1}e.preventDefault(),d(n)}),T.off("mouseenter.sc").on("mouseenter.sc","li",function(){e(this).addClass(j)}).off("mouseleave.sc").on("mouseleave.sc","li",function(){T.children().removeClass(j)}).off("click.sc").on("click.sc","li",function(){m(e(this).attr("value"));var n=e(this).attr("value");i(function(){(I(o)||t.noop)(n,s.val())}),T.hide()}),e(document).on("click.sc",function(){T.hide()})}function p(){var t=s.caret("pos"),n=x(o);if(e.isArray(n)||(n=[n+""]),!n.length)return s.val();var r=s.val(),i="",l=-1,c="",a=-1;e.each(n,function(e,n){if(n){var o=r.substring(0,t).lastIndexOf(n);o>l&&(l=o,i=n);var s=r.substring(t).indexOf(n);s>-1&&(a>-1?s<a&&(a=s,c=n):(a=s,c=n))}});var u="",f="";return l>-1&&(u=r.substring(0,l)),a>-1&&(a+=t,f=r.substring(a+c.length)),{left:u,right:f,lsep:i,lsepIdx:l,rsep:c,rsepIdx:a}}function h(){var t,n,r,i=w(o),l=parseInt(y(o),10)||240,c=p(),a=s.position(),u=s.outerWidth(),f=s.outerHeight(),h=s.caret("position"),v=c.lsepIdx;v===-1?(t=s.caret("position",0),t.left=0):t=s.caret("position",v+1),"100%"===i?(i=s.outerWidth(),n=0):(i=parseInt(i,10)||240,n=i>=u?0:t.left+i>=u?u-i:t.left),"input"===g?r=f:(r=h.top+h.height-s.scrollTop(),h.top>t.top&&(n=0));var d=0,m=0,b=s.parents().filter(function(){var t=e(this).css("position");return"absolute"===t||"fixed"===t||"relative"===t})[0];if(b){var x=e(b);d=x.scrollTop(),m=x.scrollLeft()}return{width:i,maxHeight:l,left:a.left+m+parseInt(s.css("marginLeft"),10)+n,top:a.top+d+parseInt(s.css("marginTop"),10)+r+2}}function v(){var n=p(),i=s.val(),l=n.lsep,c=n.lsepIdx,u=n.rsepIdx,f=n.rsep,v=n.left,d=n.right,m=0,g=i.length;c>-1&&(m=c+l.length),u>-1&&(g=u);var x=i.substring(m,g);(b(o)||r.noopSearchFunc)(a(x),l,v,f,d).then(function(n){return e.map(n,function(e){return t.isObject(e)?e:{label:e,value:e}})},function(){return[]}).then(function(t){return 0===t.length?void T.html("").hide():void T.html(e.map(t,function(e){return'<li value="'+e.value+'">'+e.label+"</li>"}).join("")).css(h()).show().css(h())})}function d(e){if(!T.is(":hidden")){var t=T.children();if(0!==t.length){var n=t.filter("."+j).first(),r=n;if(n.length)if(e){var i=n.prev();i.length&&(r=i)}else{var o=n.next();o.length&&(r=o)}else r=e?t.last():t.first();t.removeClass(j),r.addClass(j),m(r.attr("value"));var s=r.position().top,l=0,c=T.height()-r.height();return s>c&&T.scrollTop(T.scrollTop()+s-c),s<l?T.scrollTop(T.scrollTop()+s-l):void 0}}}function m(e){var t=p(),n=t.lsep,r=t.rsep,i=t.left,o=t.right,l="";i&&(l+=i+n),l+=e;var c=l.length;o&&(l+=r+o),s.val(l).caret("pos",c),s.focus().trigger("change")}var g,b,x,k,w,y,I,C,T,j;c()}}}])});